# Lakka Configuration File for nrf52840 Keyboard
# Bluetooth mạnh và ổn định, không tiết kiệm pin

#############################################
# CONFIG_ZMK_BLE
#############################################
# Enable BLE
CONFIG_ZMK_BLE=y
CONFIG_ZMK_BLE_CLEAR_BONDS_ON_START=n

#############################################
# Bluetooth Power and Connection Settings
#############################################
# Bluetooth TX Power (maximum for nrf52840)
CONFIG_BT_CTLR_TX_PWR_PLUS_8=y

# BLE connection parameters for stability
CONFIG_BT_MAX_CONN=5
CONFIG_BT_MAX_PAIRED=5
CONFIG_ZMK_BLE_PASSKEY_ENTRY=n

# Increased BLE intervals for stability (less frequent connection updates)
CONFIG_BT_PERIPHERAL_PREF_MAX_INT=12
CONFIG_BT_PERIPHERAL_PREF_MIN_INT=9
CONFIG_BT_GAP_AUTO_UPDATE_CONN_PARAMS=n

# Advertising settings
CONFIG_BT_EXT_ADV=y
CONFIG_BT_EXT_ADV_MAX_ADV_SET=3
CONFIG_BT_EXT_SCAN_BUF_SIZE=1650
CONFIG_ZMK_SPLIT_BLE_CENTRAL_PERIPHERALS=1

#############################################
# Encoder Configuration
#############################################
# Enable encoder support
CONFIG_ZMK_ENCODER=y
CONFIG_ZMK_ENCODER_DEFAULT_RESOLUTION=4
CONFIG_ZMK_ENCODER_DEBOUNCE_PRESS_MS=5
CONFIG_ZMK_ENCODER_DEBOUNCE_RELEASE_MS=5

# EC11 encoder driver
CONFIG_EC11=y
CONFIG_EC11_TRIGGER_GLOBAL_THREAD=y

#############################################
# Power Management and Sleep
#############################################
# Enable power management
CONFIG_ZMK_SLEEP=y

# Sleep timeout settings
# Idle timeout before entering deep sleep: 15 minutes (900000 ms)
CONFIG_ZMK_IDLE_SLEEP_TIMEOUT=900000

# Deep sleep timeout: 5 minutes (300000 ms) after idle
CONFIG_ZMK_EXT_POWER=y

# Disable power saving for maximum performance
CONFIG_PM=n
CONFIG_PM_DEVICE=n
CONFIG_SYS_POWER_MANAGEMENT=n
CONFIG_SYS_POWER_DEEP_SLEEP=n

# USB settings for always-on power when connected
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_SOF=y
CONFIG_USB_DEVICE_REMOTE_WAKEUP=n

#############################################
# Keyboard Behavior Settings
#############################################
# Debounce settings
CONFIG_ZMK_KSCAN_DEBOUNCE_PRESS_MS=5
CONFIG_ZMK_KSCAN_DEBOUNCE_RELEASE_MS=5

# Behavior settings
CONFIG_ZMK_HID_REPORT_TYPE_NKRO=y
CONFIG_ZMK_MOUSE=y
CONFIG_ZMK_BEHAVIORS_MOUSE_TICK_DURATION=8

# Keymap and layers
CONFIG_ZMK_KEYMAP_LAYERS=4

#############################################
# Logging and Debug (IDE Mode)
#############################################
# Enable logging for debugging
CONFIG_LOG=y
CONFIG_ZMK_LOG_LEVEL_INF=y
CONFIG_ZMK_USB_LOGGING=y
CONFIG_BT_DEBUG_LOG=y
CONFIG_BT_HCI_DRIVER_LOG_LEVEL_INF=y

# USB CDC ACM for serial output (helpful for debugging)
CONFIG_USB_CDC_ACM=y
CONFIG_SERIAL=y
CONFIG_UART_INTERRUPT_DRIVEN=y
CONFIG_UART_LINE_CTRL=y

# Console and shell for debugging
CONFIG_CONSOLE=y
CONFIG_SHELL=y
CONFIG_DEVICE_SHELL=y

# Heap and stack monitoring
CONFIG_HEAP_MEM_POOL_SIZE=8192
CONFIG_MAIN_STACK_SIZE=2048
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048

#############################################
# NRF52840 Specific Settings
#############################################
# Clock settings for maximum performance
CONFIG_CLOCK_CONTROL_NRF_K32SRC_XTAL=y
CONFIG_CLOCK_CONTROL_NRF_K32SRC_20PPM=y

# Radio settings
CONFIG_BT_LL_SW_SPLIT=y
CONFIG_BT_BUF_CMD_TX_COUNT=10
CONFIG_BT_BUF_EVT_RX_COUNT=20

# Increased buffer sizes for BLE
CONFIG_BT_BUF_ACL_RX_SIZE=502
CONFIG_BT_BUF_ACL_TX_SIZE=502
CONFIG_BT_CTLR_DATA_LENGTH_MAX=251

#############################################
# Performance Optimizations
#############################################
# Disable features that save power but reduce performance
CONFIG_BT_CTLR_DUP_FILTER_LEN=0
CONFIG_BT_CTLR_LE_ENC=n
CONFIG_BT_CTLR_PRIVACY=n

# Increase BLE security and performance
CONFIG_BT_CTLR_TX_BUFFER_SIZE=27
CONFIG_BT_CTLR_RX_BUFFER_SIZE=27

#############################################
# Final Optimizations
#############################################
# Ensure no low power modes are enabled
CONFIG_SYS_POWER_LOW_POWER_STATE=n
CONFIG_BT_CTLR_LOW_LAT=y
